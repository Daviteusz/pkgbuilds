name: Release

on:
  push:
  schedule:
  # Run every day at 5:20
  - cron: '20 5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    if: github.repository == 'fwcd/arch-repo'
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel

    steps:
    - name: Install system dependencies
      run: pacman -Syu --noconfirm git github-cli
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up Git config
      run: |
        git config --global --add safe.directory "$PWD"
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    - name: Update packages
      run: git submodule update --remote
    - name: Set up build user and directory permissions
      run: |
        useradd -m builder
        chown -R builder:builder .
        echo "builder ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers
        sudo -u builder git config --global protocol.file.allow always
    - name: Build packages
      run: sudo -u builder ./build-packages
    - name: Commit updates
      run: |
        git add -A
        git commit --allow-empty -m "Update packages ($(date '+%Y-%m-%d-%H-%M'))"
    - name: Push changes
      run: git push
    - name: Publish release
      if: github.ref == 'refs/heads/main'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        tag="$(date '+%Y-%m-%d-%H-%M')"
        gh release create --title "$tag" "$tag" || true
        gh release upload --clobber "$tag" build/*
